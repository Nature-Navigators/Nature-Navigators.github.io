<div class="post" data-post-id="{{ post.postID }}">
    <div class="post-header">
        <a href="/profile/{{ post.user.username }}">
            <div class="profile_pic_container">
                {% if post.user.profileImage %}
                <img id="profile_pic" src="{{ url_for('download_file', filename=post.user.profileImage.name) }}"
                    alt="Profile Picture" class="profile-pic" />
                {% else %}
                <img id="profile_pic" src="{{ url_for('static', filename='images/profile-icon.webp') }}"
                    alt="Profile Picture" class="profile-pic" />
                {% endif %}
            </div>
            <div class="profile-info">
                <div class="profile-name-time">
                    <span class="profile-name">{{ post.user.username }}</span>
                    <span class="post-time">• {{ post.datePosted|format_datetime }}</span>
                </div>
            </div>
        </a>
    </div>

    {% if post.images|length > 0 %}
    <img class="post-image" src="{{ url_for('download_file', filename=post.images[0].name) }}" alt="Post Image" />
    {% else %}
    <img class="post-image" src="{{ url_for('static', filename='images/raven.png') }}" alt="Post Image" />
    {% endif %}

    <div class="post-info">
        <div class="text-and-icons">
            <div class="likes-and-icons">
                
                <div class="post-icons">
                    <button class="icon-button like-button" id="like-button" data-post-id="{{ post.postID }}">❤️</button>
                </div>
                <div class="likes" id="post_likes_{{ post.postID }}">{{ post.likes }} likes</div>

            </div>
            <p class="post-content">{{ post.caption }}</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        setupLikeButtons();
    });

    function setupLikeButtons() {
        const likeButtons = document.querySelectorAll('.like-button');
        likeButtons.forEach(button => {
            button.addEventListener('click', handleLikeButtonClick);
        });
    }

    function handleLikeButtonClick(event) {
            const button = event.currentTarget;
            const postId = button.getAttribute('data-post-id');

            fetch(`/api/posts/${postId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin' // Include credentials for same-origin requests
            })
                .then(response => {
                    console.log('Response Status:', response.status);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Error: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.likes !== undefined) {
                        const likesCountElement = document.querySelector(`#post_likes_${postId}`);
                        if (likesCountElement) {
                            likesCountElement.textContent = `${data.likes} likes`;
                        }
                    } else {
                        console.error('Error liking post:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

</script>